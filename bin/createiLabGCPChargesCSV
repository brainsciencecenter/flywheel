#!/usr/bin/python3

import argparse
import csv
import json
import os
import pyjq
import re
import sys
import yaml

from openpyxl.utils.cell import get_column_letter, column_index_from_string

from collections import OrderedDict

GibiByte = 1024 * 1024 * 1024
TerraByte = 1024 * 1024 * 1024 * 1042

CmdName = os.path.basename(sys.argv[0])

ap = argparse.ArgumentParser()

ap.add_argument('-m', '--ilabmapfile', action='store', help='iLab service id and service request id yaml file') 
ap.add_argument('-z', '--zero', action='store_true', help='include all charges zero and below') 
ap.add_argument('gcpcharges', nargs='+', type=str, default=None, help='GCP Charges with Flywheel Allocation CSV')

args = ap.parse_args()

def initTotalCosts():
    TotalCosts = {}

    for c in ChargeTypes:
        TotalCosts[c] = 0.0

    return(TotalCosts)

def initGroupProjectCharge(
        BscOverhead=0.0,
        Compute=0.0,
        DynamicVmRatio=1.0,
        InitialAnalysisCount=0,
        Misc=0.0,
        ServiceRequestId=None,
        Storage=0.0,
        Vm=0.0,
    ):
    return({
        'BscOverhead': BscOverhead,
        'Compute': Compute,
        'DynamicVmRatio': DynamicVmRatio,
        'InitialAnalysisCount': InitialAnalysisCount,
        'Misc': Misc,
        'ServiceRequestId': ServiceRequestId,
        'Storage': Storage,
        'Vm': Vm,
    })


def getProjectGroup(iLabServiceRequestIdMap,alias):
    try:
        # way too many backslashes
        # may need to do lots of re.escapes()
        SafeAlias = re.sub('([\(\)])', r'\\\\\1', alias)

        res = pyjq.all('.["RequestIds"][][]|select((.aliases[])|match("^{}$")) | .group'.format(SafeAlias), iLabServiceRequestIdMap)
    except:
        print("{}: No alias for '{}' '{}' in iLabServiceRequestMap".format(CmdName, alias, SafeAlias), file=sys.stderr)
        res = []

    if (len(res)):
        return(res[0])
    else:
        return(None)

def getServiceId(iLabMap,alias):
    res = pyjq.all('.["ServiceIds"][]|select(.aliases[]|match("^{}$";"i")) | .service_id'.format(alias), iLabMap)
    if (len(res)):
          return(res[0])
    else:
          return(None)

def getServiceRequestId(iLabMap,alias):
    res = pyjq.all('.["RequestIds"][][]|select((.aliases[])|match("^{}$";"i")) | .service_request_id'.format(alias), iLabMap)
    if (len(res)):
          return(res[0])
    else:
          return(None)

def getChargeType(row):
    ChargeType = None

    if (re.search('Compute Engine', row['Service description'])):
        ChargeType = 'Compute'
    elif (re.search('Cloud Storage', row['Service description'])):
        ChargeType = 'Storage'
    else:
        print("row['Service description'] = '{}'".format(row['Service description']), file=sys.stderr)
        ChargeType = 'Misc'

    return("{}".format(ChargeType))
            
def isVmCharge(row):
    return(   (row['Service description'] == 'Compute Engine')
              and (
                  re.search('.*Instance Core.*', row['SKU description'])
                  or re.search('.*Small Instance.*', row['SKU description'])
                  or re.search('.*PD Capacity.*', row['SKU description'])
                  or re.search('.*Instance Ram.*', row['SKU description'])
              )
    )
    

def isInitialAnalysis(row):
    print("Service description = '{}', Project ID = '{}, Initial analysis = '{}'".format(row['Service description'], row['Project ID'], row['Initial analysis']), file=sys.stderr)

    return(row['Service description'] == 'Flywheel Gear' and row['Initial analysis'] == 'True')

def makeGcpChargeKey(row):
    Group = row['Group']
    Project = row['Project name']

    return('{}/{}'.format(Group,Project))

if (not (args.ilabmapfile)):
    print("{}: -m iLabMapFilePath argument required".format(CmdName), file=sys.stderr)
    sys.exit(1)
    
iLabMap = None

with open(args.ilabmapfile) as file:
    iLabMap = yaml.load(file, Loader=yaml.FullLoader)

GcpCharges = {}

with open(args.gcpcharges[0], newline='') as csvfile:
    reader = csv.DictReader(csvfile, delimiter=',', quotechar='"')

    for row in reader:

        Cost=float(row['Cost ($)'])

        if (Cost < 0.0):
            continue

        GcpChargeKey = makeGcpChargeKey(row)

        if (GcpChargeKey in GcpCharges):
            GroupProjectCharges = GcpCharges[GcpChargeKey]
        else:
            ServiceRequestId = getServiceRequestId(iLabMap,GcpChargeKey)
            if (ServiceRequestId == None):
                print("{}: No Service Request Id for '{}'".format(CmdName, GcpChargeKey), file=sys.stderr)
                continue
                
            if (not (re.search('^\d+$',str(ServiceRequestId)))):
                print("{}: Service Request Id for '{}' not numeric".format(CmdName, GcpChargeKey, ServiceRequestId), file=sys.stderr)
                continue

            GroupProjectCharges = initGroupProjectCharge(
                ServiceRequestId=ServiceRequestId
            )
            GcpCharges[GcpChargeKey] = GroupProjectCharges


        if (isVmCharge(row)):
            GroupProjectCharges['Vm'] += float(Cost)
            GroupProjectCharges['DynamicVmRatio'] = float(row['Dynamic VM Ratio'])
        elif(isInitialAnalysis(row)):
            GroupProjectCharges['InitialAnalysisCount'] += 1
        else:
            ChargeType = getChargeType(row)
            GroupProjectCharges[ChargeType] += Cost

print("len(GcpCharges) = {}".format(len(GcpCharges)), file=sys.stderr)

print("service_id,note,service_quantity,price,purchased_on,service_request_id,owner_email,pi_email_or_group_id,payment_number")
        
ServiceId = getServiceId(iLabMap, "BSC Flywheel Charge")

for GroupProjectKey, GroupProjectCharge in GcpCharges.items():

    ServiceRequestId = GroupProjectCharge['ServiceRequestId']
    StorageCharge = GroupProjectCharge['Storage']
    ComputeCharge = GroupProjectCharge['Compute']
    DynamicVmCharge = GroupProjectCharge['Vm'] * GroupProjectCharge['DynamicVmRatio']
    InitialAnalysisCount = GroupProjectCharge['InitialAnalysisCount']

    BscOverheadCharge = (StorageCharge * 0.25) + (InitialAnalysisCount * 25.0)

    # *** ';' work like ',' for iLab.  and you can't quote them
    Note = "Dynamic Vm: %.2f  Storage: %.2f  BSC Overhead: %.2f  Initial Analysis: %.2f" % (
        DynamicVmCharge,
        StorageCharge,
        BscOverheadCharge,
        InitialAnalysisCount,
    )

    Quantity = round(DynamicVmCharge + StorageCharge + BscOverheadCharge,2)
    
    Price = ""
    if (args.zero):
        Price = 0

    if (Quantity > 0.0):
        print("{},{},{},{},,{},,,".format(
            ServiceId,
            Note,
            "%.2f" % Quantity,
            Price,
            ServiceRequestId))

          



