#!/usr/bin/python3

#
# get all the analysises from flywheel
# filter the analysises for specified date range
# get the session ids for those analysises
# Get the flywheel paths for those sessions sorting by group/project
# Tally project totals and group totals

# from Jeff Meier

import argparse
import csv
import flywheel
import fwgearutils
import json
import re
import sys

parser = argparse.ArgumentParser()
args = parser.parse_args()

fw = fwgearutils.getFW(args, Root=True)

Sessions = {}
i = 0
for session in fw.get_all_sessions(exhaustive=True, limit=1000000):
  i += 1
  session=session.reload()
  for analysis in session.analyses:
    analysis=analysis.reload()
    if session.analyses:
      if (not session.id in Sessions.keys()):
        if (analysis.gear_info == None):
          gear = re.sub(' .*$','',analysis.label)
        else:
          gear = analysis.gear_info.name
        Sessions[session.id] = {
          'group_label': session.parents.group,
          'project_id': session.parents.project,
          'subject_id': session.parents.subject,
          'session_id': session.id,
          'analysis_id': analysis.id,
          'gear': gear,
          'created': analysis.created,
        }

for k,s in Sessions.items():
  project = fw.get(s['project_id'])
  subject = fw.get(s['subject_id'])
  session = fw.get(s['session_id'])

  print('%s,%s,%s,%s,%s,%s,%s,%s' % (
    s['group_label'],
    project.label,
    subject.label,
    session.label,
    s['gear'],
    session.id,
    s['analysis_id'],
    s['created']))

