#!/bin/bash

# syncs NACC-SC AshsHarP reports to INDD

# Assumptions
# + Only 3T reports are looked for
# + Each session only has a since analysis.  It is possible to run multiple analyses, but there is only room in the INDD for one of them.
# 

cmd=$(basename "$0")

syntax="$cmd [-D][-c CacheDir][-g Gear][-n][-v] [Group/Project]"

function sys {
	  [ -n "${opt_n}${opt_v}" ] && echo "$cmd : $@" 1>&2
	  [ -n "$opt_n" ] || "$@"
}

while getopts c:Dnv arg
do
	case "$arg" in
	     c|n|v)
		eval "opt_${arg}=${OPTARG:=1}"
		;;
	esac
done

shift $(($OPTIND - 1))

if [ -n "$1" ]
then
	GroupProject="$1"
else
	GroupProject="dwolklab/NACC-SC"
fi
Group=$(echo "$GroupProject" | cut -f 1 -d /)
Project=$(echo "$GroupProject" | cut -f 2 -d /)

Gear=ashsharpicv
[ -n "$opt_g" ] && Gear="$opt_g"

[ -n "$opt_n" ] && opt_n=-n
[ -n "$opt_v" ] && opt_v=-v

if [ -n "$opt_c" ]
then
    CacheDir="$opt_c"
else
    CacheDir="${GroupProject}/${Gear}"
fi

if [ ! -d "$CacheDir" ]
then
    echo "$cmd : CacheDir '${CacheDir}' not found " 1>&2
    exit 1
fi

cd "$CacheDir"
[ -n "${opt_n}${opt_v}" ] && echo "Current working directory = '$(pwd)'" 1>&2

CachedPdfs="$(ls | grep '.pdf$' | sort -u)"

fwsearch -r file  'group._id = '"$Group"' AND (project.label = '"$Project"') AND (file.name =~ ".*_report.pdf")' | jq -r '.[] | [ .analysis._id, .file.name] | @csv' | sort -u > /tmp/PdfWithAnalysisIds.csv

PdfsToDownload="$(diff <(csvcut -c 2 /tmp/PdfWithAnalysisIds.csv | sed 's/"//g' | sort -u ) <(echo "$CachedPdfs") | grep '^< ' | sed 's/< //')"

[ -n "${opt_n}${opt_v}" ] && echo "$cmd : PdfsToDownload = '$PdfsToDownload'" 1>&2

if [ -n "$PdfsToDownload" ]
then
	FileIds=()

	while read PdfName
	do
	    AnalysisIds=$(grep ",\"${PdfName}\"$" /tmp/PdfWithAnalysisIds.csv | csvcut -c 1 )
	    [ -z "$AnalysisIds" ] && echo "No Analyses Id for '${PdfName}'" 1>&2 && continue

	    for AnalysisId in $AnalysisIds
	    do
		AcquisitionJson=$(fwget -1 "$AnalysisId")
		[ -z "$AcquisitionJson" ] && echo "fwget -1 \"$AnalysisId\" failed" 1>&2 && continue
		PdfNameFileId=$(echo "$AcquisitionJson" | jq -r '.files[] | select(.name | match("report.pdf")) | [ .name, .file_id ] | @csv')
		PdfFileId=$(echo "$PdfNameFileId" | csvcut -c 2)
		FileIds+=( "$PdfFileId" )
	    done
	done < <(echo "$PdfsToDownload")
	
	#
	# We're already in the CachedDir
	#
	sys fwget -f --download-dir . --download ${opt_n} ${opt_v} "${FileIds[@]}"

fi

if [ -z "$opt_D" -a -n "$CachedPdfs" ]
then
    InddPdfs=$(smbClientWrapper //cndr-indd.uphs.pennhealth.prv/mrireport -c dir 2> /dev/null | awk '{print $1}' | grep -P '.pdf$' | sort -u)

    while read i
    do
	InddName=$(echo "$i" | ashsharp2INDDReportName)

	if ! grep -q "$InddName" <(echo "$InddPdfs")
	then
	    smbClientWrapper //cndr-indd.uphs.pennhealth.prv/mrireport -c 'put '"${i}"' '"'${InddName}'" 2> /dev/null
	    [ -n "${opt_n}${opt_v}" ] && echo "$cmd : smbClientWrapper //cndr-indd.uphs.pennhealth.prv/mrireport put '$i' ${InddName}'" 1>&2
	fi
    done < <(echo "$CachedPdfs")
fi


