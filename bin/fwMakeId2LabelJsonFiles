#!/bin/bash

CmdName=$(basename "$0")
Syntax="${CmdName} [-f][-m][-n][-v][-p][-t TmpDir] {Group/Project}"

function sys {
    [ -n "${opt_n}${opt_v}" ] && echo "$@" 1>&2
    [ -n "$opt_n" ] || "$@"
}

while getopts fmnpt:v arg
do
	case "$arg" in
	     f|m|n|p|t|v)
		eval "opt_${arg}='${OPTARG:=1}'"
		;;
	esac
done
		
shift $(("${OPTIND}" - 1))

GroupProject="$1"

Group=$(echo "$GroupProject" | cut -f 1 -d /)
Project=$(echo "$GroupProject" | cut -f 2 -d /)
if (echo "$GroupProject" | grep -q /) && [ -n "$Group" ] && [ -n "$Project" ]
then
    true
else
	echo "${CmdName} : Missing or malformed Group/Project '$GroupProject'" 1>&2
	echo "${Syntax}" 1>&2
	exit 1
fi

DeleteTmpDir=False
if [ -n "$opt_t" ]
then
    TmpDir="$opt_t"
else
	TmpDir=$(mktemp -d "${TMPDIR:-/tmp}/FwId2LabelsDir-XXXXXXX")
	[ -z "$opt_m" ] && DeleteTmpDir=True
fi
[ -e "$TmpDir" ] || sys mkdir -p "$TmpDir"

[ -n "$opt_p" ] && ProgressBar=-p

#
# *** May want to reorder the searches
# An item in a colleciton can be from multiple groups/projects, so may want to
# collect a list of all the group/projects in the found sessions and look up those.
#

Id2ProjectLabelsJson="${TmpDir}/Id2ProjectLabels.json"
if [ -n "$opt_f" -o ! -e "$Id2ProjectLabelsJson" ]
then
    if [ "$Group" == "Collections" ]
    then
	sys fwget -1 -c all  | jq -r '[ .[]|{ (._id): .label} ] | add' > "$Id2ProjectLabelsJson"
    else
	sys fwlookup $ProgressBar "$Group" | jq -r '[ .[].projects[] | { (._id): .label } ] | add' > "$Id2ProjectLabelsJson"
    fi
fi

ProjectId=$(jq -r 'to_entries[] | select(.value == "'"$Project"'") | .key' "$Id2ProjectLabelsJson")

Id2SubjectLabelsJson="${TmpDir}/Id2SubjectLabels.json"
if [ -n "$opt_f" -o ! -e "$Id2SubjectLabelsJson" ]
then
    if [ "$Group" == "Collections" ]
    then
	sys fwget -1 -c "$ProjectId" | jq -r '.sessions[].subject._id' | sort -u | fwget -1 | jq --slurp -r '[ .[] | { (._id): .label } ] | add ' > "$Id2SubjectLabelsJson"
    else
	#fwsearch doesn't return the subject uid
	sys fwfind -s group="$Group" parents.project="${ProjectId}" | jq '[.[]| {(._id): .label}] | add ' > "$Id2SubjectLabelsJson"
    fi
fi

Id2SessionLabelsJson="${TmpDir}/Id2SessionLabels.json"
if [ -n "$opt_f" -o ! -e "$Id2SessionLabelsJson" ]
then
    if [ "$Group" == "Collections" ]
    then
	sys fwget -1 -c "$ProjectId" | jq -r '.sessions[]._id' | sort -u | fwget -1 | jq --slurp -r '[ .[] | { (._id): .label } ] | add ' > "$Id2SessionLabelsJson"
    else
	#fwsearch doesn't return the session uid
	sys fwfind -S group="$Group" parents.project="${ProjectId}" | jq '[.[]| {(._id): .label}] | add ' > "$Id2SessionLabelsJson"
    fi
fi

CachedSessionJsonFile="${TmpDir}/CachedSessionJsonFile.json"
if [ -n "$opt_f" -o ! -e "$CachedSessionJsonFile" ]
then
    sys jq -r 'keys[]' "$Id2SessionLabelsJson" | fwget -1 | jq -r --slurp '.' > "$CachedSessionJsonFile"
fi

Id2SessionTimeStampsJson="${TmpDir}/Id2SessionTimeStamps.json"
if [ -n "$opt_f" -o ! -e "$Id2SessionTimeStampsJson" ]
then
    jq -r '[ .[] | { (._id): .timestamp } ] | add ' "$CachedSessionJsonFile" > "$Id2SessionTimeStampsJson"
fi

Id2SessionNotesJson="${TmpDir}/Id2SessionNotes.json"
if [ -n "$opt_f" -o ! -e "$Id2SessionNotesJson" ]
then
	jq '[ .[] | select( (.notes | length) > 0) | { (._id): (.notes | map(.text) | join("\n")) } ] | add' "$CachedSessionJsonFile" > "$Id2SessionNotesJson"
fi

Id2SessionTagsJson="${TmpDir}/Id2SessionTags.json"
if [ -n "$opt_f" -o ! -e "$Id2SessionTagsJson" ]
then
    sys jq '[.[]| {(._id): (.tags|join(":"))}] | add ' "$CachedSessionJsonFile" > "$Id2SessionTagsJson"
fi

if [ -z "$opt_m" ] && [ "$DeleteTmpDir" == True ]
then
    sys rm -rf "$TmpDir"
else
    [ -n "${opt_v}${opt_n}" ] && echo "${CmdName} : Leaving Id2Label Json Files in '$TmpDir'" 1>&2
fi

