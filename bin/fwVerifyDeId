#!/bin/bash

CmdName=$(basename "$0")
Syntax="${CmdName} [-n][-v][-c CachedFwAcquisitionJsonFile][-l Label2IdDir][-d DeIdProfileNullFieldsJsonFile] {Group/Project}"

FwUtilsBaseDir=$(dirname $(dirname $(realpath "$0")))
if [ ! -e "${FwUtilsBaseDir}/bin/fwget" ]
then
	FwUtilsBaseDir=$(dirname $(dirname $(which fwget)))
fi

function sys {
    [ -n "${opt_n}${opt_v}" ] && echo "$@" 1>&2
    [ -n "$opt_n" ] || "$@"
}


while getopts nvc:l:d: arg
do
	case "$arg" in 
		c|d|l|n|v)
			eval "opt_${arg}='${OPTARG:=1}'"
			;;
	esac
done

shift $(( "$OPTIND" - 1 ))

for GroupProject in "$@"
do
	Group=$(echo "$GroupProject" | cut -f 1 -d /)
	Project=$(echo "$GroupProject" | cut -f 2 -d /)

	PiiCheckerJqFile=${FwUtilsBaseDir}/lib/PiiChecker.jq

	if [ -n "$opt_d" ]
	then
	    SiteDeIdProfileJson=$(cat "$opt_d")
	else
	    SiteDeIdProfileJson=$(fwget -1 -s all | jq -r '[ .deid_profile.dicom.fields[] | select(.name != "DeidentificationMethod") | { (.name): true } ] | add')
	fi

	Label2IdDir="$GroupProject"
	if [ -n "$opt_l" ] 
	then
	    Label2IdDir="$opt_l"
	else
	    if [ ! -e "$LabelDir" ]
	    then
		LabelDir=$(mktemp -d /tmp/Label2IdDir-XXXXXX)
	    fi
	fi

	sys fwMakeId2LabelJsonFiles -t "$LabelDir" "${Group}/${Project}"

	CachedFwAcquisitionJsonFile="${Group}-${Project}-CachedFwAcquisitions.json"
	[ -n "$opt_c" ] && CachedFwAcquisitionJsonFile="$opt_c"

	jq -r -n --argjson Header true --argjson DeIdProfileNullFields "$SiteDeIdProfileJson" -f "$PiiCheckerJqFile" -L "$Label2IdDir" /dev/null

	jq -r --argjson Header false --argjson DeIdProfileNullFields "$SiteDeIdProfileJson" -f "$PiiCheckerJqFile" -L "$Label2IdDir" "$CachedFwAcquisitionJsonFile"

done

